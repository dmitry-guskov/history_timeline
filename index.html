<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>History Timeline (Local)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f8;
      margin: 0;
      padding: 16px;
    }
    h1 { text-align: center; color: #333; margin: 8px 0 16px; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 10px; }
    .toolbar > * { font-size: 14px; }
    button { padding: 6px 10px; border: 1px solid #bbb; border-radius: 6px; background: #fff; cursor: pointer; }
    button:hover { background: #eee; }
    input[type="file"] { display: none; }
    label.file-btn { padding: 6px 10px; border: 1px solid #bbb; border-radius: 6px; background: #fff; cursor: pointer; }
    .scroller { width: 100%; overflow-x: auto; border: 3px solid #ccc; background: #fff; padding-bottom: 40px; position: relative; }
    .timeline { position: relative; height: calc(var(--rows) * 80px + 40px); }
    .timeline::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 4px; background: #bbb; transform: translateY(-50%); }
    .event { position: absolute; background: #fff; border-radius: 8px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; cursor: pointer; transition: transform .2s ease, box-shadow .2s ease; }
    .event:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
    .title { font-weight: bold; margin-bottom: 6px; color: #222; font-size: 14px; }
    .tag { align-self: flex-start; font-size: 11px; padding: 2px 6px; border-radius: 4px; color: #fff; margin-bottom: 6px; white-space: nowrap; }
    .range { font-size: 11px; color: #555; white-space: nowrap; }
    a { color: inherit; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .filters { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-top: 6px; }
    .pill { padding: 4px 8px; border: 1px solid #ccc; border-radius: 999px; background: #fff; cursor: pointer; font-size: 12px; }
    .pill.active { background: #333; color: #fff; border-color: #333; }
    .status { text-align: center; font-size: 12px; color: #666; margin: 6px 0; }
  </style>
</head>
<body>
  <h1>History Timeline (Local)</h1>
  <div class="toolbar">
    <label class="file-btn" for="fileInput">Open lectures.json</label>
    <input id="fileInput" type="file" accept="application/json" />
    <input id="search" type="search" placeholder="Search title..." />
    <button id="zoomOut">− Zoom</button>
    <button id="zoomIn">+ Zoom</button>
    <button id="fit">Fit to Data</button>
    <button id="reset">Reset</button>
    <button id="editToggle">Edit Mode</button>
    <button id="exportJson">Export JSON</button>
  </div>
  <div class="filters" id="filters"></div>
  <div class="status" id="status">Load a JSON file with lecture items.</div>
  <div class="scroller">
    <div id="timeline" class="timeline"></div>
  </div>

  <!-- Modal Editor -->
  <div id="modal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.4); align-items:center; justify-content:center;">
    <div style="background:#fff; padding:16px; border-radius:8px; width:min(540px, 92vw); box-shadow:0 10px 30px rgba(0,0,0,0.25);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <strong>Edit Lecture</strong>
        <button id="modalClose" title="Close">✕</button>
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
        <label style="grid-column:1 / -1;">
          <div style="font-size:12px; color:#555;">Title</div>
          <input id="fldTitle" type="text" style="width:100%; padding:6px;" />
        </label>
        <label>
          <div style="font-size:12px; color:#555;">Start (year, use negative for BCE)</div>
          <input id="fldStart" type="number" step="1" style="width:100%; padding:6px;" />
        </label>
        <label>
          <div style="font-size:12px; color:#555;">End (year)</div>
          <input id="fldEnd" type="number" step="1" style="width:100%; padding:6px;" />
        </label>
        <label style="grid-column:1 / -1;">
          <div style="font-size:12px; color:#555;">URL</div>
          <input id="fldUrl" type="url" style="width:100%; padding:6px;" />
        </label>
        <label style="grid-column:1 / -1;">
          <div style="font-size:12px; color:#555;">Tags (comma separated)</div>
          <input id="fldTags" type="text" style="width:100%; padding:6px;" />
        </label>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
        <button id="modalCancel">Cancel</button>
        <button id="modalSave" style="background:#2ecc71; color:#fff; border-color:#27ae60;">Save</button>
      </div>
    </div>
  </div>

  <script>
    const tagColors = {
      'Global': '#6C5CE7',
      'Middle East': '#e17055',
      'Europe': '#00b894',
      'Central Asia': '#fdcb6e',
      'East Asia': '#0984e3',
      'Americas': '#d63031',
      'America': '#d63031',
      'North America': '#d63031',
      'South America': '#ff7675',
      'Africa': '#00cec9',
      'Asia': '#00cec9',
      'USA': '#d63031',
      '20th century': '#6C5CE7',
      'Ancient History': '#00b894',
      'Egypt': '#fdcb6e',
      'Medieval History': '#e17055',
      'Japan': '#0984e3',
      'Eurasia': '#55efc4',
      'Anatolia': '#e84393',
      'Mesopotamia': '#a29bfe',
      'Hellenistic Period': '#6C5CE7',
      'lecture': '#636e72'
    };

    const timeline = document.getElementById('timeline');
    const fileInput = document.getElementById('fileInput');
    const statusEl = document.getElementById('status');
    const filtersEl = document.getElementById('filters');
    const searchInput = document.getElementById('search');

    let lectures = [];
    let activeTags = new Set();
    let scale = 0.05; // px per year
    const MIN_SCALE = 0.01, MAX_SCALE = 5;
    let editMode = false;
    let editingIndex = null; // index in lectures

    function setStatus(text) { statusEl.textContent = text; }
    function clearTimeline() { while (timeline.firstChild) timeline.removeChild(timeline.firstChild); }

    function normalizeItem(item) {
      if (!item || typeof item !== 'object') return null;
      const title = String(item.title || '').trim();
      const url = item.url || (item.videoId ? `https://youtu.be/${item.videoId}` : '#');
      const tags = Array.isArray(item.tags) ? item.tags : [];
      const start = Number(item.start);
      const end = Number(item.end);
      if (!title) return null;
      if (!Number.isFinite(start) || !Number.isFinite(end)) return null;
      return { title, url, tags, start, end, publishedAt: item.publishedAt || null };
    }

    function buildFilters(items) {
      filtersEl.innerHTML = '';
      const allTags = new Set();
      items.forEach(i => (i.tags || []).forEach(t => allTags.add(t)));
      const sorted = Array.from(allTags).sort();
      sorted.forEach(tag => {
        const btn = document.createElement('button');
        btn.className = 'pill';
        btn.textContent = tag;
        btn.onclick = () => {
          if (activeTags.has(tag)) activeTags.delete(tag); else activeTags.add(tag);
          btn.classList.toggle('active');
          renderTimeline();
        };
        filtersEl.appendChild(btn);
      });
    }

    function assignRowsByPixels(events, gapPx = 12) {
      const rowRights = [];
      events.forEach(lec => {
        let placed = false;
        for (let i = 0; i < rowRights.length; i++) {
          if (lec.left >= rowRights[i] + gapPx) {
            lec.row = i;
            rowRights[i] = lec.left + lec.width;
            placed = true;
            break;
          }
        }
        if (!placed) {
          lec.row = rowRights.length;
          rowRights.push(lec.left + lec.width);
        }
      });
      return rowRights.length;
    }

    function renderTimeline() {
      clearTimeline();
      let items = lectures.slice();

      const q = searchInput.value.trim().toLowerCase();
      if (q) items = items.filter(i => i.title.toLowerCase().includes(q));
      if (activeTags.size) items = items.filter(i => i.tags?.some(t => activeTags.has(t)));

      if (!items.length) { setStatus('No items to display.'); return; }

      items.sort((a,b) => a.start - b.start);
      const minYear = Math.min(...items.map(l => Math.min(l.start, l.end)));
      items.forEach(lec => {
        const s = Math.min(lec.start, lec.end);
        const e = Math.max(lec.start, lec.end);
        const duration = Math.max(0, e - s);
        lec.left = (s - minYear) * scale;
        lec.width = Math.max(2, duration * scale, 150); // min width for readability
      });

      const rowCount = assignRowsByPixels(items);
      const maxRight = Math.max(...items.map(l => l.left + l.width));
      timeline.style.width = `${maxRight + 60}px`;
      timeline.style.setProperty('--rows', rowCount);

      items.forEach(lec => {
        let color = '#636e72';
        for (const tag of lec.tags || []) { if (tagColors[tag]) { color = tagColors[tag]; break; } }
        const el = document.createElement('div');
        el.className = 'event';
        el.style.border = `3px solid ${color}`;
        el.style.left = `${lec.left}px`;
        const verticalOffset = (lec.row - (rowCount - 1) / 2) * 80;
        el.style.top = `calc(50% + ${verticalOffset}px)`;
        el.style.width = `${lec.width}px`;
        el.innerHTML = `
          <div class="title"><a href="${lec.url}" target="_blank" rel="noopener noreferrer">${lec.title}</a></div>
          <div class="tag" style="background:${color}">${(lec.tags||[]).join(', ')}</div>
          <div class="range">${lec.start} – ${lec.end}</div>
        `;
        if (editMode) {
          el.style.cursor = 'alias';
          el.addEventListener('click', () => openEditorByRef(lec));
        }
        timeline.appendChild(el);
      });

      setStatus(`${items.length} items | scale ${scale.toFixed(2)} px/year`);
    }

    function fitToData() {
      if (!lectures.length) return;
      const durations = lectures.map(l => Math.abs(l.end - l.start));
      const median = durations.sort((a,b)=>a-b)[Math.floor(durations.length/2)] || 100;
      const targetWidth = 260; // desired median width
      scale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, targetWidth / Math.max(1, median)));
      renderTimeline();
    }

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (!Array.isArray(data)) throw new Error('Root must be an array');
        const normalized = data.map(normalizeItem).filter(Boolean);
        if (!normalized.length) throw new Error('No valid items found');
        lectures = normalized;
        buildFilters(lectures);
        fitToData();
      } catch (err) {
        setStatus(`Failed to load: ${err.message || err}`);
      }
    });

    document.getElementById('zoomIn').addEventListener('click', () => { scale = Math.min(MAX_SCALE, scale * 1.5); renderTimeline(); });
    document.getElementById('zoomOut').addEventListener('click', () => { scale = Math.max(MIN_SCALE, scale / 1.5); renderTimeline(); });
    document.getElementById('reset').addEventListener('click', () => { activeTags.clear(); searchInput.value=''; fitToData(); });
    document.getElementById('fit').addEventListener('click', () => fitToData());
    searchInput.addEventListener('input', () => renderTimeline());
    window.addEventListener('resize', () => renderTimeline());

    // Edit mode toggle
    const editBtn = document.getElementById('editToggle');
    editBtn.addEventListener('click', () => {
      editMode = !editMode;
      editBtn.textContent = editMode ? 'Exit Edit' : 'Edit Mode';
      renderTimeline();
    });

    // Export JSON
    document.getElementById('exportJson').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(lectures, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'lectures_edited.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    // Modal editor logic
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modalClose');
    const modalCancel = document.getElementById('modalCancel');
    const modalSave = document.getElementById('modalSave');
    const fldTitle = document.getElementById('fldTitle');
    const fldStart = document.getElementById('fldStart');
    const fldEnd = document.getElementById('fldEnd');
    const fldUrl = document.getElementById('fldUrl');
    const fldTags = document.getElementById('fldTags');

    function openEditorByRef(lec) {
      const idx = lectures.findIndex(x => x.title === lec.title && x.url === lec.url);
      if (idx === -1) return;
      editingIndex = idx;
      fldTitle.value = lectures[idx].title || '';
      fldStart.value = Number.isFinite(lectures[idx].start) ? lectures[idx].start : '';
      fldEnd.value = Number.isFinite(lectures[idx].end) ? lectures[idx].end : '';
      fldUrl.value = lectures[idx].url || '';
      fldTags.value = Array.isArray(lectures[idx].tags) ? lectures[idx].tags.join(', ') : '';
      modal.style.display = 'flex';
    }

    function closeEditor() {
      modal.style.display = 'none';
      editingIndex = null;
    }

    function saveEditor() {
      if (editingIndex == null) return;
      const start = parseInt(fldStart.value, 10);
      const end = parseInt(fldEnd.value, 10);
      lectures[editingIndex] = {
        ...lectures[editingIndex],
        title: fldTitle.value.trim(),
        start: Number.isFinite(start) ? start : lectures[editingIndex].start,
        end: Number.isFinite(end) ? end : lectures[editingIndex].end,
        url: fldUrl.value.trim() || lectures[editingIndex].url,
        tags: fldTags.value.split(',').map(s => s.trim()).filter(Boolean)
      };
      closeEditor();
      renderTimeline();
    }

    modalClose.addEventListener('click', closeEditor);
    modalCancel.addEventListener('click', closeEditor);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeEditor(); });
    modalSave.addEventListener('click', saveEditor);
  </script>
</body>
</html>


